---

- hosts: localhost
  connection: local
  gather_facts: no
  tasks:
    - name: launch docker containers for testing
      when: "{{ testing | default('false') }}"
      docker_service:
        project_name: refapp-docker
        definition:
          version: '3'

          services:
            db:
              image: mysql:5.6
              environment:
                MYSQL_ROOT_PASSWORD: root
                MYSQL_DATABASE: openmrs

            openmrs-server:
              build: ./
              depends_on:
                - db
              image: ubuntu:latest
              ports:
                - '18080:8080'
                - '10080:80'
                - '10443:443'
                - '10022:22'
                      
- hosts: openmrs-servers
  become: true
  
  tasks:
  - name: Install apt dependencies
    apt:
      name: "{{item}}"
      state: present
      update_cache: yes
    with_items:
      - apache2
      - tomcat8
      - unzip
      
  - name: Download war file
    get_url:
      url: https://sourceforge.net/projects/openmrs/files/releases/OpenMRS_Platform_2.1.2/openmrs.war
      dest: /var/lib/tomcat8/webapps/openmrs.war
      mode: 0644
      owner: tomcat8
      
  - name: Restart tomcat
    service:
      name: tomcat8
      state: restarted
      
  - name: Unpack war file
    unarchive:
      src: /var/lib/tomcat8/webapps/openmrs.war
      dest: /var/lib/tomcat8/webapps/openmrs/
      copy: no
      mode: 0755
      owner: tomcat8
      group: tomcat8
      
  - name: Create OpenMRS directory
    file:
      path: /var/lib/OpenMRS
      owner: tomcat8
      group: tomcat8
      state: directory
      mode: 0755
      